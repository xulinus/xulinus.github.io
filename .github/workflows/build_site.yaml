# https://gohugo.io/host-and-deploy/host-on-github-pages/
name: Build and deploy 
on:
  push:
    branches:
     - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v5
      - name: Setup Go ${{ matrix.go-version }}
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.x' 
      
      # Clone the code that builds the webpages
      - name: Clone code repo 
        env: 
          TOKEN: ${{ secrets.CLONE_TOKEN }}
        run: |
          git clone https://xulinus:${TOKEN}@github.com/xulinus/mdblog.git \
            --branch main \
            --single-branch \
            --depth 1 \
            --quiet 
          pwd
          ls
      - name: Pull Go dependencies
        run: |
          cd /home/runner/work/xulinus.github.io/xulinus.github.io/mdblog/
          go get github.com/gomarkdown/markdown@latest
      - name: Copy MD 
        run: |
          mkdir /home/runner/work/xulinus.github.io/xulinus.github.io/mdblog/md
          mkdir /home/runner/work/xulinus.github.io/xulinus.github.io/mdblog/html
          cp /home/runner/work/xulinus.github.io/xulinus.github.io/md/* /home/runner/work/xulinus.github.io/xulinus.github.io/mdblog/md/
      - name: Make HTML 
        run: |
          cd /home/runner/work/xulinus.github.io/xulinus.github.io/mdblog/ 
          go run main.go 
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: /home/runner/work/xulinus.github.io/xulinus.github.io/mdblog/html/

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
